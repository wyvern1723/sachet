import 'dart:collection';

import 'package:sachet/services/get_jwxt_data/fetch_data_http/fetch_exam_time_semesters.dart';
import 'package:html/parser.dart';

/// 获取考试时间查询的学期
///
/// return [当前学期,{semesterLabel: semesterValue,.......} ({学期名称(网页显示的文本): 学期值(实际的值)})]
///
/// {semesterLabel: semesterValue,.......}: eg. {"2024-2025-2":"2024-2025-2","2024-2025-1":"2024-2025-1","2023-2024-2":"2023-2024-2"}
Future<List> getExamTimeSemestersData() async {
  var result = await fetchExamTimeSemestersData();

  var document = parse(encoding: '', result);

  // pathElement 表示在 html DOM 里的位置，减少代码量。
  var pathElement = document.getElementById('xnxqid');
  var listLength = pathElement?.children.length ?? 10;

  Map<String, String> semestersData = {};

  String? currentSemester = '';
  for (int i = 1; i < listLength + 1; i++) {
    var child = pathElement?.children[i - 1];

    String? semesterLabel = child?.innerHtml;
    String? semesterValue = child?.attributes['value'];

    if ((child?.attributes.containsKey('selected') == true)) {
      currentSemester = semesterValue;
    }
    semestersData.addAll({
      semesterLabel ?? '': semesterValue ?? '',
    });
  }
  // 考试时间一页获取的 考试时间是乱序的（本来网页中这部分也是隐藏的，没有选择的选项）
  /* 
  原：
  {
  "2019-2020-1": "2019-2020-1",
  "2017-2018-2": "2017-2018-2",
  "2022-2023-1": "2022-2023-1",
  "2018-2019-2": "2018-2019-2",
  "2023-2024-2": "2023-2024-2",
  "2009-2010-2": "2009-2010-2",
  "2009-2010-1": "2009-2010-1",
  "2008-2009-2": "2008-2009-2",
  "2008-2009-1": "2008-2009-1",
  "2007-2008-2": "2007-2008-2",
  "2007-2008-1": "2007-2008-1",
  "2006-2007-2": "2006-2007-2",
  "2006-2007-1": "2006-2007-1",
  "2005-2006-2": "2005-2006-2",
  "2005-2006-1": "2005-2006-1",
  "2004-2005-2": "2004-2005-2",
  "2004-2005-1": "2004-2005-1",
  "2003-2004-2": "2003-2004-2",
  "2003-2004-1": "2003-2004-1",
  "2002-2003-2": "2002-2003-2",
  "2002-2003-1": "2002-2003-1",
  "2001-2002-2": "2001-2002-2",
  "2015-2016-2": "2015-2016-2",
  "2015-2016-1": "2015-2016-1",
  "2014-2015-2": "2014-2015-2",
  "2014-2015-1": "2014-2015-1",
  "2013-2014-2": "2013-2014-2",
  "2013-2014-1": "2013-2014-1",
  "2012-2013-2": "2012-2013-2",
  "2012-2013-1": "2012-2013-1",
  "2011-2012-2": "2011-2012-2",
  "2011-2012-1": "2011-2012-1",
  "2010-2011-2": "2010-2011-2",
  "2010-2011-1": "2010-2011-1",
  "1999-2000-2": "1999-2000-2",
  "2016-2017-1": "2016-2017-1",
  "2000-2001-2": "2000-2001-2",
  "1999-2000-1": "1999-2000-1",
  "2000-2001-1": "2000-2001-1",
  "2001-2002-1": "2001-2002-1",
  "1998-1999-1": "1998-1999-1",
  "2017-2018-1": "2017-2018-1",
  "2016-2017-2": "2016-2017-2",
  "2024-2025-2": "2024-2025-2",
  "2020-2021-1": "2020-2021-1",
  "2021-2022-1": "2021-2022-1",
  "2021-2022-2": "2021-2022-2",
  "2022-2023-2": "2022-2023-2",
  "2023-2024-1": "2023-2024-1",
  "2018-2019-1": "2018-2019-1",
  "2019-2020-2": "2019-2020-2",
  "2020-2021-2": "2020-2021-2",
  "2024-2025-1": "2024-2025-1",
  };
  
  排序后：
  {
  "2024-2025-2": "2024-2025-2",
  "2024-2025-1": "2024-2025-1",
  "2023-2024-2": "2023-2024-2",
  "2023-2024-1": "2023-2024-1",
  "2022-2023-2": "2022-2023-2",
  "2022-2023-1": "2022-2023-1",
  "2021-2022-2": "2021-2022-2",
  "2021-2022-1": "2021-2022-1",
  "2020-2021-2": "2020-2021-2",
  "2020-2021-1": "2020-2021-1",
  "2019-2020-2": "2019-2020-2",
  "2019-2020-1": "2019-2020-1",
  "2018-2019-2": "2018-2019-2",
  "2018-2019-1": "2018-2019-1",
  "2017-2018-2": "2017-2018-2",
  "2017-2018-1": "2017-2018-1",
  "2016-2017-2": "2016-2017-2",
  "2016-2017-1": "2016-2017-1",
  "2015-2016-2": "2015-2016-2",
  "2015-2016-1": "2015-2016-1",
  "2014-2015-2": "2014-2015-2",
  "2014-2015-1": "2014-2015-1",
  "2013-2014-2": "2013-2014-2",
  "2013-2014-1": "2013-2014-1",
  "2012-2013-2": "2012-2013-2",
  "2012-2013-1": "2012-2013-1",
  "2011-2012-2": "2011-2012-2",
  "2011-2012-1": "2011-2012-1",
  "2010-2011-2": "2010-2011-2",
  "2010-2011-1": "2010-2011-1",
  "2009-2010-2": "2009-2010-2",
  "2009-2010-1": "2009-2010-1",
  "2008-2009-2": "2008-2009-2",
  "2008-2009-1": "2008-2009-1",
  "2007-2008-2": "2007-2008-2",
  "2007-2008-1": "2007-2008-1",
  "2006-2007-2": "2006-2007-2",
  "2006-2007-1": "2006-2007-1",
  "2005-2006-2": "2005-2006-2",
  "2005-2006-1": "2005-2006-1",
  "2004-2005-2": "2004-2005-2",
  "2004-2005-1": "2004-2005-1",
  "2003-2004-2": "2003-2004-2",
  "2003-2004-1": "2003-2004-1",
  "2002-2003-2": "2002-2003-2",
  "2002-2003-1": "2002-2003-1",
  "2001-2002-2": "2001-2002-2",
  "2001-2002-1": "2001-2002-1",
  "2000-2001-2": "2000-2001-2",
  "2000-2001-1": "2000-2001-1",
  "1999-2000-2": "1999-2000-2",
  "1999-2000-1": "1999-2000-1",
  "1998-1999-1": "1998-1999-1"
  };
  */
  final sortedSemestersData = SplayTreeMap<String, dynamic>.from(
      semestersData, (a, b) => b.compareTo(a));

  return [currentSemester, sortedSemestersData];
}
