import 'package:flutter/foundation.dart';
import 'package:sachet/providers/zhengfang_user_provider.dart';
import 'package:sachet/services/zhengfang_jwxt/get_data/fetch_data/fetch_gpa_semesters.dart';
import 'package:sachet/services/zhengfang_jwxt/get_data/parse_data/parse_gpa_semesters.dart';
import 'package:sachet/services/zhengfang_jwxt/login/zhengfang_login_service.dart';

/// 从正方教务系统获取学分绩点排名查询页面的可选起始学年学期和终止学年学期
///
/// Return (
/// Map<起始学年学期标签: 对应的值>,
/// Map<终止学年学期标签: 对应的值>,
/// )
///
/// e.g.
///
/// ```
/// (
/// {
///     "全部": "",
///     "2030-2031-2": "203012",
///     "2030-2031-1": "203003",
///     "2029-2030-2": "202912",
///     "2029-2030-1": "202903",
///     "2028-2029-2": "202812",
///     "2028-2029-1": "202803",
///     "2027-2028-2": "202712",
///     "2027-2028-1": "202703",
///     "2026-2027-2": "202612",
///     "2026-2027-1": "202603",
///     "2025-2026-2": "202512",
///     "2025-2026-1": "202503",
///     "2024-2025-2": "202412",
///     "2024-2025-1": "202403",
///     "2023-2024-2": "202312",
///     "2023-2024-1": "202303",
///     "2022-2023-2": "202212",
///     "2022-2023-1": "202203",
///     "2021-2022-2": "202112",
///     "2021-2022-1": "202103",
///     "2020-2021-2": "202012",
///     "2020-2021-1": "202003",
///     "2019-2020-2": "201912",
///     "2019-2020-1": "201903",
///     "2018-2019-2": "201812",
///     "2018-2019-1": "201803",
///     "2017-2018-2": "201712",
///     "2017-2018-1": "201703",
///     "2016-2017-2": "201612",
///     "2016-2017-1": "201603",
///     "2015-2016-2": "201512",
///     "2015-2016-1": "201503",
///     "2014-2015-2": "201412",
///     "2014-2015-1": "201403",
///     "2013-2014-2": "201312",
///     "2013-2014-1": "201303",
///     "2012-2013-2": "201212",
///     "2012-2013-1": "201203",
///     "2011-2012-2": "201112",
///     "2011-2012-1": "201103",
///     "2010-2011-2": "201012",
///     "2010-2011-1": "201003",
///     "2009-2010-2": "200912",
///     "2009-2010-1": "200903",
///     "2008-2009-2": "200812",
///     "2008-2009-1": "200803",
///     "2007-2008-2": "200712",
///     "2007-2008-1": "200703",
///     "2006-2007-2": "200612",
///     "2006-2007-1": "200603",
///     "2005-2006-2": "200512",
///     "2005-2006-1": "200503",
///     "2004-2005-2": "200412",
///     "2004-2005-1": "200403",
///     "2003-2004-2": "200312",
///     "2003-2004-1": "200303",
///     "2002-2003-2": "200212",
///     "2002-2003-1": "200203",
///     "2001-2002-2": "200112",
///     "2001-2002-1": "200103"
/// },
/// {
///     "全部": "",
///     "2030-2031-2": "203012",
///     "2030-2031-1": "203003",
///     "2029-2030-2": "202912",
///     "2029-2030-1": "202903",
///     "2028-2029-2": "202812",
///     "2028-2029-1": "202803",
///     "2027-2028-2": "202712",
///     "2027-2028-1": "202703",
///     "2026-2027-2": "202612",
///     "2026-2027-1": "202603",
///     "2025-2026-2": "202512",
///     "2025-2026-1": "202503",
///     "2024-2025-2": "202412",
///     "2024-2025-1": "202403",
///     "2023-2024-2": "202312",
///     "2023-2024-1": "202303",
///     "2022-2023-2": "202212",
///     "2022-2023-1": "202203",
///     "2021-2022-2": "202112",
///     "2021-2022-1": "202103",
///     "2020-2021-2": "202012",
///     "2020-2021-1": "202003",
///     "2019-2020-2": "201912",
///     "2019-2020-1": "201903",
///     "2018-2019-2": "201812",
///     "2018-2019-1": "201803",
///     "2017-2018-2": "201712",
///     "2017-2018-1": "201703",
///     "2016-2017-2": "201612",
///     "2016-2017-1": "201603",
///     "2015-2016-2": "201512",
///     "2015-2016-1": "201503",
///     "2014-2015-2": "201412",
///     "2014-2015-1": "201403",
///     "2013-2014-2": "201312",
///     "2013-2014-1": "201303",
///     "2012-2013-2": "201212",
///     "2012-2013-1": "201203",
///     "2011-2012-2": "201112",
///     "2011-2012-1": "201103",
///     "2010-2011-2": "201012",
///     "2010-2011-1": "201003",
///     "2009-2010-2": "200912",
///     "2009-2010-1": "200903",
///     "2008-2009-2": "200812",
///     "2008-2009-1": "200803",
///     "2007-2008-2": "200712",
///     "2007-2008-1": "200703",
///     "2006-2007-2": "200612",
///     "2006-2007-1": "200603",
///     "2005-2006-2": "200512",
///     "2005-2006-1": "200503",
///     "2004-2005-2": "200412",
///     "2004-2005-1": "200403",
///     "2003-2004-2": "200312",
///     "2003-2004-1": "200303",
///     "2002-2003-2": "200212",
///     "2002-2003-1": "200203",
///     "2001-2002-2": "200112",
///     "2001-2002-1": "200103"
/// }
/// )
/// ```
Future<
    ({
      Map<String, String> startSemesters,
      Map<String, String> endSemesters,
    })> getGPASemestersZF({
  required String cookie,
  required ZhengFangUserProvider? zhengFangUserProvider,
}) async {
  try {
    final html = await fetchGPASemetersZF(cookie: cookie);
    return parseGPASemestersFromHtmlZF(html);
  } catch (e) {
    if (e == '获取可查询学期数据失败: Http status code = 302, 可能需要重新登录') {
      if (zhengFangUserProvider == null) {
        rethrow;
      }

      final studentID = zhengFangUserProvider.user.studentID;
      if (studentID == null) {
        rethrow;
      }

      final password = await ZhengFangUserProvider.readPassword();
      if (password == null) {
        rethrow;
      }

      final zhengFangLoginService = ZhengFangLoginService();
      try {
        await zhengFangLoginService.login(
          username: studentID,
          password: password,
        );
        String cookie = zhengFangLoginService.cookie;
        await zhengFangUserProvider.setCookie(cookie);
      } catch (reLoginError) {
        if (kDebugMode) {
          print(reLoginError);
        }
        // 登录失败，重新抛出 fetchGPASemetersZF() 的 error，（仍提示登录失效，需要用户手动去登录）
        throw e;
      }
      // 登录成功
      // 重新读取最新 cookie
      final newCookie = ZhengFangUserProvider.cookie;
      // 重新加载数据
      final html = await fetchGPASemetersZF(cookie: newCookie);
      return parseGPASemestersFromHtmlZF(html);
    } else {
      rethrow;
    }
  }
}
